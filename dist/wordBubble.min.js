function WordBubble(){function a(a){_.defaults(a,{fill:"white",strokeWidth:10,strokeColor:"black",depth:10,font:"Helvetica",fontSize:30,width:screen.width,baselineShift:0,innerStroke:!0,align:"center"});var c,d=+a.depth,e=+a.strokeWidth,f=+a.baselineShift,g=document.createElement("canvas"),h=g.getContext("2d"),i=window.devicePixelRatio||1,j=h.webkitBackingStorePixelRatio||h.backingStorePixelRatio||1,k=i/j,l=a.fontSize+"pt "+a.font;h.font=l;var m=b(h,a.text,a.width-2*e-10),n=m.lines,o=a.width;g.width=k*o,g.style.width=o+"px";var p=+a.lineHeight||+a.fontSize+ +e,q=a.height?a.height:p*n.length+2*+e+20+d;g.height=k*q,g.style.height=q+"px";var r=(g.width-m.widest)/2;a.fill.colors?(c=h.createLinearGradient(r,.1*q,o-r,.9*q),a.fill.colors.forEach(function(a){c.addColorStop(a.stop,a.color)})):c=a.fill.color||a.fill;var s,t=e/2+d+10+f;s="right"===a.align?o-e-5:"left"===a.align?e+5:o/2;var u=0;for(h.scale(k,k),h.font=l,h.globalAlpha=1,h.globalCompositeOperation="source-over",h.fillStyle=a.strokeColor,h.textAlign=a.align,h.textBaseline="top",h.lineWidth=2*e,h.lineJoin="round",h.strokeStyle=a.strokeColor,u=0;d>u;u++)n.forEach(function(a,b){var c=p*b;h.fillText(a,s,c+t-u+e),h.strokeText(a,s,c+t-u+e)});return h.fillStyle=c,n.forEach(function(b,c){var d=p*c;h.globalAlpha=1,h.globalCompositeOperation="source-over",h.fillText(b,s,d+t-u+e),a.innerStroke&&(h.globalAlpha=.75,h.lineWidth=2,h.strokeStyle="white",h.globalCompositeOperation="soft-light",h.strokeText(b,s,d+t-u+e))}),g.className="word-bubble",a.animation&&g.classList.add(a.animation),g}function b(a,b,c){for(var d=b.split("\n"),e=[],f=0,g=0;g<d.length;g++){for(var h=d[g].split(" "),i="",j=0;j<h.length;j++){var k=i+h[j]+" ",l=a.measureText(k.trim()),m=l.width;m>c&&j>0?(e.push(i.trim()),i=h[j]+" "):(i=k,f=Math.max(f,m))}e.push(i.trim())}return{lines:e,widest:f}}this.pop=function(b,c,d){d&&c&&c.querySelector&&Array.prototype.forEach.call(c.querySelectorAll("canvas.word-bubble"),function(a){c.removeChild(a)});var e=[].concat(b).map(function(b){return a(b)});return c&&c.querySelector&&e.forEach(function(a){c.appendChild(a),a.offsetWidth,a.classList.add("enter")}),b instanceof Array?e:e[0]}}